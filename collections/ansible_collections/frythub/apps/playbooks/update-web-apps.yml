- name: Update Frythub web apps (no Nginx changes)
  hosts: web
  become: true
  gather_facts: true

  vars_files:
    - "{{ apps_vars_file }}"

  vars:
    repo_url: "git@github.com:frythub/frythub-web.git"
    repo_root_test: "/var/www/frythub-web-test"
    repo_root_prod: "/var/www/frythub-web-prod"
    target_env: "test"  # override with -e "target_env=prod"
    app_user: "ansible"
    apps_vars_file: "/etc/ansible/cicd/apps.yml"
    repo_branch_test: "dev"
    repo_branch_prod: "main"

  pre_tasks:
    - name: Fail if target_env is invalid
      ansible.builtin.fail:
        msg: "target_env must be 'test' or 'prod'"
      when: target_env not in ['test', 'prod']

    - name: Set repo_root based on target_env
      ansible.builtin.set_fact:
        repo_root: "{{ repo_root_test if target_env == 'test' else repo_root_prod }}"

    - name: Select apps by environment
      ansible.builtin.set_fact:
        selected_apps: "{{ apps | selectattr('env', 'equalto', target_env) | list }}"

    - name: Compute unique app names for build step
      ansible.builtin.set_fact:
        unique_app_names: "{{ selected_apps | map(attribute='name') | unique | list }}"

    - name: Collect systemd web app template candidates
      ansible.builtin.set_fact:
        systemd_template_candidates:
          - "{{ playbook_dir }}/templates/systemd-web-app.service.j2"
          - "{{ playbook_dir }}/../templates/systemd-web-app.service.j2"

    - name: Check systemd template candidates on controller
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ systemd_template_candidates }}"
      register: systemd_template_stats
      delegate_to: localhost
      become: false
      run_once: true
      loop_control:
        label: "{{ item }}"

    - name: Pick first existing systemd template
      ansible.builtin.set_fact:
        systemd_web_app_template: "{{ systemd_template_stats.results | selectattr('stat.exists','equalto', true) | map(attribute='stat.path') | first | default('') }}"
      run_once: true

    - name: Fail if systemd web app template is missing
      ansible.builtin.fail:
        msg: "systemd web app template not found on controller; expected at {{ systemd_template_candidates }}"
      when: systemd_web_app_template == ""

  tasks:
    - name: Ensure base directory exists for this env
      ansible.builtin.file:
        path: "{{ repo_root }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Update monorepo for this env
      become_user: "{{ app_user }}"
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_root }}"
        version: "{{ repo_branch_test if target_env == 'test' else repo_branch_prod }}"
        accept_hostkey: yes
        depth: 1
        single_branch: yes
        update: yes
        force: no

    - name: Install pnpm globally (if needed)
      ansible.builtin.command: npm install -g pnpm
      args:
        creates: /usr/local/bin/pnpm

    - name: Install monorepo dependencies with pnpm
      become_user: "{{ app_user }}"
      ansible.builtin.command: pnpm install --prod=false
      args:
        chdir: "{{ repo_root }}"

    - name: Build each app for this env
      become_user: "{{ app_user }}"
      ansible.builtin.command: "pnpm --filter {{ item }} build"
      args:
        chdir: "{{ repo_root }}"
      loop: "{{ unique_app_names }}"
      loop_control:
        label: "{{ item }}"

    - name: Check for existing systemd service units
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ item.name }}-{{ item.env }}.service"
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"
      register: service_units

    - name: Render missing systemd service units
      ansible.builtin.template:
        src: "{{ systemd_web_app_template }}"
        dest: "/etc/systemd/system/{{ item.item.name }}-{{ item.item.env }}.service"
        mode: "0644"
      loop: "{{ service_units.results }}"
      when: not item.stat.exists
      loop_control:
        label: "{{ item.item.name }}-{{ item.item.env }}"

    - name: Ensure web app services are enabled and running
      ansible.builtin.systemd:
        name: "{{ item.name }}-{{ item.env }}"
        enabled: true
        state: restarted
        daemon_reload: true
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"

    - name: Verify web app services are active
      ansible.builtin.command: systemctl is-active "{{ item.name }}-{{ item.env }}"
      register: service_status
      failed_when: service_status.rc != 0
      changed_when: false
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"

- name: Deploy Frythub web apps (test + prod)
  hosts: web
  become: true
  gather_facts: true

  vars_files:
    - "{{ inventory_dir }}/../group_vars/web/apps.yml"

  vars:
    repo_url: "git@github.com:frythub/frythub-web.git"

    # separate roots for each env
    repo_root_test: "/var/www/frythub-web-test"
    repo_root_prod: "/var/www/frythub-web-prod"

    # override with: -e "target_env=test" or -e "target_env=prod"
    target_env: "test"

    pm2_user: "ansible"
    swap_file: "/swapfile"
    swap_size_mb: 2048
    min_swap_mb: 512

  pre_tasks:
    - name: Fail if target_env is invalid
      ansible.builtin.fail:
        msg: "target_env must be 'test' or 'prod'"
      when: target_env not in ['test', 'prod']

    - name: Set repo_root based on target_env
      ansible.builtin.set_fact:
        repo_root: "{{ repo_root_test if target_env == 'test' else repo_root_prod }}"

    - name: Select apps by environment
      ansible.builtin.set_fact:
        selected_apps: "{{ apps | selectattr('env', 'equalto', target_env) | list }}"

    - name: Compute unique app names for build step
      ansible.builtin.set_fact:
        unique_app_names: "{{ selected_apps | map(attribute='name') | unique | list }}"

    - name: Ensure swap is present on low-memory hosts
      when: (ansible_swaptotal_mb | default(0)) < min_swap_mb
      block:
        - name: Create swap file if missing
          ansible.builtin.command: "fallocate -l {{ swap_size_mb }}M {{ swap_file }}"
          args:
            creates: "{{ swap_file }}"
          register: swapfile_create

        - name: Set swap file permissions
          ansible.builtin.file:
            path: "{{ swap_file }}"
            owner: root
            group: root
            mode: "0600"

        - name: Format swap file
          ansible.builtin.command: "mkswap {{ swap_file }}"
          when: swapfile_create is changed

        - name: Check active swap devices
          ansible.builtin.command: swapon --noheadings --show=NAME
          register: swap_on
          changed_when: false

        - name: Enable swap file
          ansible.builtin.command: "swapon {{ swap_file }}"
          when: swap_file not in (swap_on.stdout_lines | default([]))

        - name: Persist swap in fstab
          ansible.builtin.lineinfile:
            path: /etc/fstab
            regexp: "^{{ swap_file | regex_escape }}\\s+"
            line: "{{ swap_file }} none swap sw 0 0"
            state: present
            create: true

  tasks:
    # ---------- REPO PER ENV ----------

    - name: Ensure base directory exists for this env
      ansible.builtin.file:
        path: "{{ repo_root }}"
        state: directory
        owner: "{{ pm2_user }}"
        group: "{{ pm2_user }}"
        mode: "0755"

    - name: Checkout monorepo for this env
      become_user: "{{ pm2_user }}"
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_root }}"
        version: main
        depth: 1
        single_branch: yes
        update: yes
        accept_hostkey: yes
        force: no

    - name: Install pnpm globally (if needed)
      ansible.builtin.command: npm install -g pnpm
      args:
        creates: /usr/local/bin/pnpm

    - name: Install monorepo dependencies with pnpm
      become_user: "{{ pm2_user }}"
      ansible.builtin.command: pnpm install --prod=false
      args:
        chdir: "{{ repo_root }}"

    # ---------- BUILD ONCE PER APP NAME (PER ENV REPO) ----------

    - name: Build each app for this env
      become_user: "{{ pm2_user }}"
      ansible.builtin.command: "pnpm --filter {{ item }} build"
      args:
        chdir: "{{ repo_root }}"
      loop: "{{ unique_app_names }}"
      loop_control:
        label: "{{ item }}"

    # ---------- PM2 CONFIG & RUNTIME PER APP+ENV ----------

    - name: Ensure PM2 config directory exists
      ansible.builtin.file:
        path: "/etc/pm2"
        state: directory
        mode: "0755"

    - name: Create PM2 ecosystem config for each app/env
      ansible.builtin.template:
        src: "../templates/pm2-ecosystem-app.js.j2"
        dest: "/etc/pm2/{{ item.name }}-{{ item.env }}.ecosystem.config.js"
        mode: "0644"
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"

    - name: Configure PM2 startup for {{ pm2_user }} (systemd unit)
      become: true
      become_user: root
      ansible.builtin.command: >
        pm2 startup systemd -u {{ pm2_user }} --hp /home/{{ pm2_user }}
      register: pm2_startup
      failed_when: pm2_startup.rc not in [0, 1]
      changed_when: "'systemd' in pm2_startup.stdout or pm2_startup.rc == 0"

    - name: Ensure PM2 service is enabled and started
      ansible.builtin.systemd:
        name: "pm2-{{ pm2_user }}"
        enabled: true
        state: started
        daemon_reload: true

    # --- IMPORTANT: nuke old processes so new cwd/repo_root is used ---

    - name: Delete existing PM2 process for this app/env (if any)
      become_user: "{{ pm2_user }}"
      ansible.builtin.command: pm2 delete {{ item.name }}-{{ item.env }}
      register: pm2_delete_result
      failed_when: pm2_delete_result.rc not in [0, 1]
      changed_when: pm2_delete_result.rc == 0
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"

    - name: Start app processes with PM2 from ecosystem config
      become_user: "{{ pm2_user }}"
      ansible.builtin.command: >
        pm2 start /etc/pm2/{{ item.name }}-{{ item.env }}.ecosystem.config.js
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.name }}-{{ item.env }}"

    - name: Save PM2 process list
      become_user: "{{ pm2_user }}"
      ansible.builtin.command: pm2 save

    # ---------- NGINX PER APP+ENV ----------

    - name: Configure Nginx server blocks for each app/env
      ansible.builtin.template:
        src: "../templates/nginx-app.conf.j2"
        dest: "/etc/nginx/sites-available/{{ item.name }}-{{ item.env }}.conf"
        mode: "0644"
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.domain }} ({{ item.env }})"

    - name: Enable Nginx sites
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item.name }}-{{ item.env }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item.name }}-{{ item.env }}.conf"
        state: link
        force: true
      loop: "{{ selected_apps }}"
      loop_control:
        label: "{{ item.domain }} ({{ item.env }})"

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload Nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
      when: nginx_test.rc == 0
